# 前端展示问题修复说明

## 问题描述

根据截图显示，前端页面存在以下问题：

1. **表格字段显示为空**：
   - "请求ID"列显示为空
   - "节点"列显示为空
   - "时间"列显示为空
   - 只有"延时(ms)"和"状态"列有数据

2. **图表图例显示"undefined"**：
   - 图表图例显示为"undefined"而不是节点名称

3. **数据格式不匹配**：
   - 后端返回的是下划线格式（`request_id`, `node_name`, `request_start_time`）
   - 前端期望的是驼峰格式（`requestId`, `nodeName`, `requestStartTime`）

## 根本原因

后端配置使用了 `PropertyNamingStrategies.SNAKE_CASE`，导致所有JSON字段都转换为下划线格式。

## 修复方案

### 1. 后端修复

为 `ChainLatencyDataVO` 类添加 `@JsonProperty` 注解，确保返回驼峰格式：

```java
@JsonProperty("requestId")
private String requestId;

@JsonProperty("nodeName")
private String nodeName;

@JsonProperty("requestStartTime")
private LocalDateTime requestStartTime;
```

### 2. 前端修复

#### 2.1 表格字段兼容处理

修改表格列定义，兼容两种格式：

```vue
<el-table-column label="请求ID" width="180" show-overflow-tooltip>
  <template #default="scope">
    {{ scope.row.requestId || scope.row.request_id || '-' }}
  </template>
</el-table-column>
```

#### 2.2 数据映射处理

在获取数据后，统一转换为驼峰格式：

```javascript
latestData.value = (data.items || []).map(item => ({
  ...item,
  requestId: item.requestId || item.request_id,
  nodeName: item.nodeName || item.node_name,
  requestStartTime: item.requestStartTime || item.request_start_time,
  requestEndTime: item.requestEndTime || item.request_end_time,
  collectionTime: item.collectionTime || item.collection_time
}))
```

#### 2.3 图表数据修复

修复图表更新函数，确保节点名称正确显示：

```javascript
const updateChart = () => {
  const nodeData = {}
  latestData.value.forEach(item => {
    const nodeName = item.nodeName || item.node_name || '未知节点'
    if (!nodeData[nodeName]) {
      nodeData[nodeName] = []
    }
    nodeData[nodeName].push(item.latency || 0)
  })

  const series = Object.keys(nodeData).map(nodeName => ({
    name: nodeName || '未知节点',  // 确保名称不为空
    type: 'line',
    data: nodeData[nodeName]
  }))
  
  chart.setOption({
    xAxis: { data: xData },
    series: series
  })
}
```

#### 2.4 时间格式处理

增强时间格式化函数，处理多种时间格式：

```javascript
const formatTime = (time) => {
  if (!time) return '-'
  try {
    if (typeof time === 'string') {
      const timeStr = time.replace('T', ' ').substring(0, 19)
      return new Date(timeStr).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      })
    }
    return new Date(time).toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    })
  } catch (e) {
    return time.toString()
  }
}
```

## 修复的文件

1. **后端**：
   - `api/src/main/java/io/github/guojiaxing1995/easyJmeter/controller/v1/ChainDataCollectionController.java`
     - 为 `ChainLatencyDataVO` 添加 `@JsonProperty` 注解

2. **前端**：
   - `web/src/view/chain/chain-collection.vue`
     - 修复表格字段显示
     - 修复图表数据映射
     - 增强时间格式化
   
   - `web/src/view/chain/chain-analysis.vue`
     - 修复表格字段显示
     - 修复图表更新函数
     - 修复瓶颈分析函数

## 测试验证

修复后需要验证：

1. ✅ 表格所有列都能正确显示数据
2. ✅ 图表图例显示正确的节点名称
3. ✅ 时间格式正确显示
4. ✅ 数据兼容下划线和驼峰两种格式

## 注意事项

1. **向后兼容**：前端代码兼容两种格式，确保即使后端返回下划线格式也能正常显示
2. **数据安全**：所有字段访问都添加了默认值处理，避免显示undefined或null
3. **错误处理**：时间格式化函数添加了try-catch，避免解析失败导致页面崩溃

---

**修复日期**: 2024-11-19  
**修复人员**: AI Assistant

