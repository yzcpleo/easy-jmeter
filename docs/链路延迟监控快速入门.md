# 链路延迟监控快速入门

## 🎯 目标：查看某一链路上各个节点耗时及整体耗时统计

### 快速步骤（3步完成）

#### 步骤1：配置链路和节点（首次使用需要）

1. 进入 **链路延时监控** → **链路管理**
2. 点击 **新增链路**，创建你的链路（例如："订单处理链路"）
3. 点击 **节点管理**，添加各个节点：
   - 节点1：网关（Gateway）
   - 节点2：订单服务（OrderService）
   - 节点3：支付服务（PaymentService）
   - 节点4：数据库（Database）
4. 为每个节点配置：
   - 日志路径（例如：`/var/log/order-service.log`）
   - 日志解析规则（提取延时的正则表达式）

#### 步骤2：启动数据收集

1. 进入 **链路延时监控** → **数据收集**
2. 选择你创建的链路
3. 输入任务ID（例如：`task_20241119_001`）
4. 点击 **启动收集** 按钮
5. 等待数据收集启动（状态显示为"运行中"）

#### 步骤3：查看各节点耗时和整体耗时

**方法A：性能分析页面（推荐，最详细）**

1. 进入 **链路延时监控** → **性能分析**
2. 选择链路和时间范围（例如：最近1小时）
3. 选择时间粒度（建议选择"5分钟"）
4. 点击 **查询** 按钮

**查看结果**：

- **性能概览卡片**（页面顶部）：
  - **平均延时**：整个链路的平均总耗时（例如：125ms）
  - **P95延时**：95%的请求总耗时低于此值（例如：250ms）
  - **成功率**：请求成功率（例如：95%）
  - **总请求数**：统计的请求总数

- **节点性能对比图**（页面中部）：
  - 柱状图显示各节点的平均延时对比
  - 可以直观看出哪个节点耗时最长

- **节点性能对比表格**（页面中部）：
  ```
  节点名称    平均延时    P95延时    P99延时    最大延时    错误率
  网关        50ms       100ms      150ms      200ms      1.5%
  订单服务    80ms       150ms      200ms      300ms      2.0%
  支付服务    60ms       120ms      180ms      250ms      1.0%
  数据库      15ms       30ms       50ms       80ms       0.5%
  ```

- **瓶颈节点分析表格**（页面底部）：
  - 系统自动识别出性能瓶颈节点
  - 显示优化建议

**方法B：实时监控页面（快速查看）**

1. 进入 **链路延时监控** → **实时监控**
2. 选择链路（系统自动设置时间范围为最近1小时）
3. 点击 **查询** 按钮

**查看结果**：

- **性能指标卡片**（页面顶部）：
  - 平均延时、成功率、P95延时、错误数

- **节点性能对比图**（页面底部）：
  - 各节点平均延时对比柱状图

---

## 📊 数据说明

### 各节点耗时统计

| 指标 | 含义 | 示例值 |
|------|------|--------|
| **平均延时** | 该节点所有请求的平均耗时 | 50ms |
| **P95延时** | 95%的请求耗时低于此值 | 100ms |
| **P99延时** | 99%的请求耗时低于此值 | 150ms |
| **最大延时** | 该节点的最大耗时 | 200ms |
| **错误率** | 失败请求占比 | 1.5% |

### 整体耗时统计

| 指标 | 含义 | 说明 |
|------|------|------|
| **平均链路延时** | 整个链路的平均总耗时 | 从第一个节点到最后一个节点的总时间 |
| **P95链路延时** | 95%的请求总耗时低于此值 | 评估大部分请求的性能 |
| **最大链路延时** | 整个链路的最大总耗时 | 最慢的请求总耗时 |

**重要**：
- **整体耗时** ≠ **各节点耗时之和**
- 整体耗时 = 最后一个节点结束时间 - 第一个节点开始时间
- 各节点耗时之和 = 各节点自身处理时间之和
- 两者差异可能包括：网络传输时间、节点间等待时间等

---

## 🔍 实际使用示例

### 场景：分析订单处理链路的性能

**链路配置**：
- 链路名称：订单处理链路
- 节点1：API网关（Gateway）
- 节点2：订单服务（OrderService）
- 节点3：支付服务（PaymentService）
- 节点4：数据库（Database）

**操作步骤**：

1. **启动数据收集**
   - 进入：链路延时监控 → 数据收集
   - 选择"订单处理链路"
   - 输入任务ID：`order_task_001`
   - 点击"启动收集"

2. **运行压测**
   - 在JMeter中运行压测任务
   - 系统自动收集各节点的延时数据

3. **查看分析结果**
   - 进入：链路延时监控 → 性能分析
   - 选择"订单处理链路"和压测时间段
   - 点击"查询"

4. **查看结果**：

   **整体性能**：
   - 平均链路延时：125ms
   - P95链路延时：250ms
   - 成功率：95%

   **各节点耗时**：
   ```
   网关：平均50ms，P95 100ms
   订单服务：平均80ms，P95 150ms  ← 瓶颈节点
   支付服务：平均60ms，P95 120ms
   数据库：平均15ms，P95 30ms
   ```

   **分析结论**：
   - 订单服务是性能瓶颈（平均延时最高）
   - 整体链路延时125ms，其中订单服务占80ms（64%）
   - 建议优化订单服务的性能

---

## 💡 使用技巧

### 1. 快速定位瓶颈节点

- 查看 **瓶颈节点分析** 表格（性能分析页面）
- 对比各节点的 **平均延时** 和 **P95延时**
- 关注 **错误率** 较高的节点

### 2. 对比不同时间段

- 在性能分析页面选择不同的时间范围
- 对比优化前后的性能数据
- 查看性能趋势变化

### 3. 查看单个请求的详细链路

- 在性能分析页面的"详细数据"表格中
- 找到感兴趣的请求ID
- 查看该请求在各节点的耗时分布

### 4. 实时监控压测过程

- 使用实时监控页面
- 选择链路后自动查询最近1小时数据
- 可以手动刷新查看最新数据

---

## ❓ 常见问题

### Q: 为什么看不到数据？

**检查清单**：
1. ✅ 数据收集是否已启动？（数据收集页面查看状态）
2. ✅ 时间范围是否正确？（包含数据收集的时间段）
3. ✅ 日志路径是否正确？（节点配置中检查）
4. ✅ 日志解析规则是否正确？（能否提取延时数据）

### Q: 如何理解整体耗时和各节点耗时？

- **整体耗时**：用户感受到的总耗时（端到端）
- **节点耗时**：各节点自身的处理时间
- **关系**：整体耗时 ≥ 各节点耗时之和（因为包含网络传输、等待时间等）

### Q: 如何优化性能？

1. 查看瓶颈节点分析结果
2. 重点关注平均延时和P95延时最高的节点
3. 优化对应服务的性能
4. 对比优化前后的数据

---

## 📝 总结

要实现"查看某一链路上各个节点耗时及整体耗时统计"，只需要：

1. **配置链路和节点**（首次使用）
2. **启动数据收集**
3. **进入性能分析页面查询**

**推荐使用"性能分析"页面**，因为它提供了最详细的分析数据，包括：
- ✅ 各节点的详细耗时统计（平均、P95、P99、最大、最小）
- ✅ 整体链路的耗时统计
- ✅ 瓶颈节点自动识别
- ✅ 详细的数据表格

---

**快速参考**：
- 📖 详细文档：`docs/链路延迟监控功能使用指南.md`
- 🔧 API文档：Swagger UI（访问 `/swagger-ui.html`）
- 💬 技术支持：联系开发团队

