# 启动问题修复说明

## 问题描述

根据日志分析，后端服务启动时存在以下问题：

1. **MyBatis 枚举类型映射错误**
   - 错误：`Could not set property 'jmeterStatus' of 'class io.github.guojiaxing1995.easyJmeter.model.MachineDO' with value 'IN_PROGRESS'`
   - 原因：`MachineMapper.xml` 中配置了枚举 TypeHandler，但 `MachineDO.jmeterStatus` 字段是 `Integer` 类型，不是枚举类型

2. **Java 版本不一致**
   - 日志显示有时使用 Java 1.8.0_341，有时使用 Java 17.0.4.1
   - 不同 Java 版本可能导致行为不一致

## 修复方案

### 方案1：修复 MachineMapper.xml ✅

**问题**：`MachineMapper.xml` 中为 `jmeterStatus` 字段配置了枚举 TypeHandler，但该字段是 `Integer` 类型。

**修复**：移除枚举 TypeHandler，使用标准的 `INTEGER` 类型映射。

**修改文件**：`api/src/main/resources/mapper/MachineMapper.xml`

**修改内容**：
```xml
<!-- 修复前 -->
<result column="jmeter_status" property="jmeterStatus" typeHandler="com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler"/>

<!-- 修复后 -->
<!-- jmeterStatus 是 Integer 类型，不是枚举类型，因此不需要 typeHandler -->
<result column="jmeter_status" jdbcType="INTEGER" property="jmeterStatus"/>
```

**说明**：
- `MachineDO.jmeterStatus` 字段定义为 `Integer` 类型（见 `MachineDO.java` 第32行）
- `JmeterStatusEnum` 枚举的 `@EnumValue` 标注的值是 `Integer` 类型
- 代码中通过 `status.getValue()` 获取整数值后设置到 `jmeterStatus` 字段
- 因此数据库映射应该直接使用 `INTEGER` 类型，不需要枚举 TypeHandler

### 方案4：修复 start.cmd ✅

**问题**：`start.cmd` 使用系统默认的 Java，可能在不同环境下使用不同版本的 Java。

**修复**：添加 Java 版本检测逻辑，优先使用 Java 8。

**修改文件**：`api/start.cmd`

**功能**：
1. **自动查找 Java 8**：
   - 检查常见的 Java 8 安装路径（如 `C:\Program Files\Java\jdk1.8.0_341`）
   - 检查 `JAVA_HOME` 环境变量
   - 如果找不到，使用系统 PATH 中的 Java

2. **版本验证**：
   - 检查 Java 版本是否符合要求
   - 如果检测到非 Java 8 版本，会显示警告但继续启动

3. **错误处理**：
   - 检查 JAR 文件是否存在
   - 检查配置文件是否存在
   - 提供清晰的错误提示

**启动脚本特性**：
- 自动检测 Java 安装路径
- 优先使用 Java 8
- 版本验证和警告
- 清晰的错误提示
- UTF-8 编码支持

## 验证修复

修复后，启动服务应该：

1. ✅ 不再出现 `argument type mismatch` 错误
2. ✅ 能够正确读取数据库中的 `jmeter_status` 字段
3. ✅ 使用一致的 Java 版本启动
4. ✅ 提供清晰的启动信息

## 测试建议

1. **清理并重新编译**：
   ```bash
   cd api
   mvn clean package -DskipTests
   ```

2. **启动服务**：
   ```bash
   cd api
   start.cmd
   ```

3. **检查日志**：
   - 查看 `api/logs/application.log`
   - 确认没有 `argument type mismatch` 错误
   - 确认服务正常启动

4. **验证功能**：
   - 测试压力机管理功能
   - 确认 `jmeterStatus` 字段能正常读取和更新

## 相关文件

- `api/src/main/resources/mapper/MachineMapper.xml` - MyBatis 映射配置
- `api/src/main/java/io/github/guojiaxing1995/easyJmeter/model/MachineDO.java` - 数据模型
- `api/src/main/java/io/github/guojiaxing1995/easyJmeter/common/enumeration/JmeterStatusEnum.java` - 枚举定义
- `api/start.cmd` - 启动脚本
- `api/src/main/java/io/github/guojiaxing1995/easyJmeter/init/JmeterStatusFixer.java` - 数据修复器

## 注意事项

1. **数据库数据**：如果数据库中仍有字符串类型的 `jmeter_status` 值，`JmeterStatusFixer` 会在启动时自动修复
2. **Java 版本**：建议使用 Java 8，项目配置要求 Java 8（见 `pom.xml`）
3. **编码问题**：启动脚本已设置 UTF-8 编码，确保中文显示正常

---

**修复日期**: 2024-11-19  
**修复人员**: AI Assistant

