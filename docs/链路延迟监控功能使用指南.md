# 链路延迟监控功能使用指南

## 目录

1. [功能概述](#功能概述)
2. [功能模块说明](#功能模块说明)
3. [使用流程](#使用流程)
4. [各节点耗时及整体耗时统计](#各节点耗时及整体耗时统计)
5. [常见问题](#常见问题)

---

## 功能概述

链路延迟监控功能用于在压力测试过程中，实时收集和分析请求在各个服务节点的耗时情况，帮助识别性能瓶颈、优化系统架构。

### 核心能力

- ✅ **实时监控**：实时收集各节点的延时数据
- ✅ **节点分析**：查看每个节点的耗时统计（平均、P95、P99、最大、最小）
- ✅ **整体统计**：计算整个链路的总体耗时
- ✅ **趋势分析**：查看延时和吞吐量的时间趋势
- ✅ **瓶颈识别**：自动识别性能瓶颈节点
- ✅ **历史对比**：支持历史数据查询和对比分析

---

## 功能模块说明

系统提供了三个主要功能模块：

### 1. 数据收集 (`chain-collection.vue`)

**功能**：启动和停止链路数据收集，查看实时收集的数据

**主要功能**：
- 启动数据收集：选择链路和任务ID，启动数据收集
- 停止数据收集：停止正在运行的数据收集任务
- 查看实时数据：查看最新收集的延时数据
- 查看历史数据：查看指定时间范围内的历史数据

**使用场景**：
- 在压测开始前启动数据收集
- 实时查看数据收集状态和最新数据
- 压测结束后停止数据收集

### 2. 实时监控 (`chain-monitoring.vue`)

**功能**：实时监控链路的性能指标和趋势

**主要功能**：
- 性能指标卡片：显示平均延时、成功率、P95延时、错误数
- 延时趋势图：显示链路整体延时的时间趋势
- 吞吐量趋势图：显示请求吞吐量的时间趋势
- 节点性能对比图：对比各个节点的平均延时

**使用场景**：
- 压测过程中实时监控链路性能
- 快速了解整体性能状况
- 识别性能异常时间段

### 3. 性能分析 (`chain-analysis.vue`)

**功能**：对历史数据进行深度分析和统计

**主要功能**：
- 性能概览：显示整体性能指标
- 延时趋势分析：按时间粒度分析延时趋势
- 吞吐量趋势：分析请求吞吐量变化
- 节点性能对比：对比各节点的详细性能指标
- 延时分布：查看延时的分布情况
- 瓶颈节点分析：自动识别并分析瓶颈节点
- 详细数据表格：查看每条请求的详细数据

**使用场景**：
- 压测结束后进行深度分析
- 对比不同时间段的性能差异
- 识别性能瓶颈节点
- 生成性能分析报告

---

## 使用流程

### 完整使用流程

#### 第一步：配置链路和节点

1. 进入 **链路管理** → **链路列表**
2. 创建或选择要监控的链路
3. 配置链路中的各个节点：
   - 节点名称、类型、描述
   - 日志路径和解析规则
   - 节点执行顺序

#### 第二步：启动数据收集

1. 进入 **链路监控** → **数据收集**
2. 选择链路和输入任务ID
3. 点击 **启动收集** 按钮
4. 系统开始从各节点的日志文件中收集延时数据

#### 第三步：实时监控（可选）

1. 进入 **链路监控** → **实时监控**
2. 选择链路和时间范围（默认最近1小时）
3. 点击 **查询** 按钮
4. 查看实时性能指标和趋势图表

#### 第四步：性能分析

1. 进入 **链路监控** → **性能分析**
2. 选择链路和时间范围
3. 选择时间粒度（分钟/5分钟/小时）
4. 点击 **查询** 按钮
5. 查看详细的分析结果和瓶颈节点

---

## 各节点耗时及整体耗时统计

### 如何查看各节点耗时

#### 方法1：通过"性能分析"页面（推荐）

1. 进入 **链路监控** → **性能分析**
2. 选择链路和时间范围
3. 点击 **查询**
4. 查看 **节点性能对比** 图表和表格

**显示内容**：
- 每个节点的平均延时（avgLatency）
- P95延时（p95Latency）
- P99延时（p99Latency）
- 最大延时（maxLatency）
- 最小延时（minLatency）
- 错误率（errorRate）

#### 方法2：通过"实时监控"页面

1. 进入 **链路监控** → **实时监控**
2. 选择链路和时间范围
3. 点击 **查询**
4. 查看 **节点性能对比** 图表

**显示内容**：
- 各节点的平均延时对比（柱状图）

#### 方法3：通过"数据收集"页面

1. 进入 **链路监控** → **数据收集**
2. 选择链路
3. 点击 **查看历史数据**
4. 在数据表格中可以看到每条请求在各个节点的耗时

### 如何查看整体耗时

#### 方法1：通过"性能分析"页面（推荐）

1. 进入 **链路监控** → **性能分析**
2. 选择链路和时间范围
3. 点击 **查询**
4. 查看 **性能概览** 卡片：
   - **平均延时**：整个链路的平均总耗时
   - **P95延时**：95%的请求总耗时
   - **总请求数**：统计的请求总数

**说明**：
- 整体耗时 = 请求从进入第一个节点到离开最后一个节点的总时间
- 系统会自动关联同一请求ID在不同节点的数据，计算总耗时

#### 方法2：通过"实时监控"页面

1. 进入 **链路监控** → **实时监控**
2. 选择链路和时间范围
3. 点击 **查询**
4. 查看顶部的性能指标卡片：
   - **平均延时**：链路整体平均耗时
   - **P95延时**：链路整体P95耗时

#### 方法3：通过API直接查询

```bash
# 获取链路性能统计（包含整体耗时）
GET /v1/chain/collection/chain-stats/{chainId}?startTime=2024-01-01 10:00:00&endTime=2024-01-01 11:00:00

# 响应示例
{
  "chainId": 1,
  "chainName": "订单处理链路",
  "avgChainLatency": 125.5,  // 整体平均耗时（毫秒）
  "p95ChainLatency": 250.0,  // 整体P95耗时（毫秒）
  "p99ChainLatency": 400.0,  // 整体P99耗时（毫秒）
  "maxChainLatency": 500,    // 整体最大耗时（毫秒）
  "minChainLatency": 10,      // 整体最小耗时（毫秒）
  "nodeStats": {              // 各节点统计
    "1": {
      "nodeId": 1,
      "nodeName": "网关",
      "avgLatency": 50.0,     // 该节点平均耗时
      "p95Latency": 100.0
    },
    "2": {
      "nodeId": 2,
      "nodeName": "订单服务",
      "avgLatency": 80.0,
      "p95Latency": 150.0
    }
  }
}
```

### 如何查看单个请求的完整链路耗时

#### 方法1：通过"性能分析"页面的详细数据表格

1. 进入 **链路监控** → **性能分析**
2. 选择链路和时间范围
3. 点击 **查询**
4. 滚动到页面底部的 **详细数据** 表格
5. 表格中显示每条请求的：
   - 请求ID
   - 各节点的耗时
   - 节点名称
   - 时间信息

#### 方法2：通过API查询单个请求的链路耗时

```bash
# 计算单个请求的链路总延时
GET /v1/chain/collection/latency/{requestId}

# 响应示例
{
  "requestId": "req_12345",
  "chainLatency": 125,  // 链路总耗时（毫秒）
  "nodeCount": 3,        // 节点数量
  "nodes": [
    {
      "nodeId": 1,
      "nodeName": "网关",
      "latency": 50,     // 该节点耗时
      "startTime": "2024-01-01 10:00:00",
      "endTime": "2024-01-01 10:00:00.050"
    },
    {
      "nodeId": 2,
      "nodeName": "订单服务",
      "latency": 60,
      "startTime": "2024-01-01 10:00:00.050",
      "endTime": "2024-01-01 10:00:00.110"
    },
    {
      "nodeId": 3,
      "nodeName": "数据库",
      "latency": 15,
      "startTime": "2024-01-01 10:00:00.110",
      "endTime": "2024-01-01 10:00:00.125"
    }
  ]
}
```

---

## 数据说明

### 节点耗时统计指标

| 指标 | 说明 | 用途 |
|------|------|------|
| **平均延时** (avgLatency) | 该节点所有请求的平均耗时 | 了解节点的一般性能水平 |
| **P95延时** (p95Latency) | 95%的请求耗时低于此值 | 评估大部分请求的性能 |
| **P99延时** (p99Latency) | 99%的请求耗时低于此值 | 评估极端情况下的性能 |
| **最大延时** (maxLatency) | 该节点的最大耗时 | 了解最坏情况 |
| **最小延时** (minLatency) | 该节点的最小耗时 | 了解最佳情况 |
| **错误率** (errorRate) | 失败请求占总请求的百分比 | 评估节点稳定性 |

### 整体耗时统计指标

| 指标 | 说明 | 计算公式 |
|------|------|----------|
| **平均链路延时** | 整个链路的平均总耗时 | 所有请求的总耗时 / 请求数 |
| **P95链路延时** | 95%的请求总耗时低于此值 | 对所有请求总耗时排序，取95%分位数 |
| **最大链路延时** | 整个链路的最大总耗时 | 所有请求总耗时的最大值 |
| **最小链路延时** | 整个链路的最小总耗时 | 所有请求总耗时的最小值 |

**注意**：
- 链路总耗时 = 最后一个节点的结束时间 - 第一个节点的开始时间
- 系统会自动关联同一请求ID在不同节点的数据
- 如果某个节点的数据缺失，该请求可能无法计算总耗时

---

## 使用示例

### 示例1：查看订单处理链路的各节点耗时

**场景**：想了解订单处理链路中，网关、订单服务、支付服务、数据库四个节点的耗时情况

**操作步骤**：

1. **进入性能分析页面**
   - 导航：链路监控 → 性能分析

2. **选择链路和时间范围**
   - 链路：选择"订单处理链路"
   - 时间范围：选择最近1小时（或压测时间段）
   - 粒度：选择"5分钟"

3. **点击查询**

4. **查看结果**：
   - **性能概览**：看到整体平均延时 125ms，P95延时 250ms
   - **节点性能对比图**：看到各节点的平均延时对比
   - **节点性能对比表格**：看到详细数据：
     ```
     网关：平均50ms，P95 100ms
     订单服务：平均80ms，P95 150ms
     支付服务：平均60ms，P95 120ms
     数据库：平均15ms，P95 30ms
     ```
   - **瓶颈节点分析**：系统自动识别出"订单服务"是瓶颈节点

### 示例2：实时监控压测过程中的性能

**场景**：压测正在进行，想实时查看链路性能

**操作步骤**：

1. **启动数据收集**（如果还没启动）
   - 进入：链路监控 → 数据收集
   - 选择链路和任务ID
   - 点击"启动收集"

2. **进入实时监控页面**
   - 导航：链路监控 → 实时监控

3. **选择链路**
   - 系统自动设置时间范围为最近1小时

4. **点击查询**
   - 系统每5分钟自动刷新数据（可手动刷新）

5. **查看结果**：
   - 顶部指标卡片：快速了解整体性能
   - 延时趋势图：查看延时是否在上升
   - 吞吐量趋势图：查看请求量变化
   - 节点性能对比：快速识别哪个节点耗时最长

### 示例3：分析某个请求的完整链路耗时

**场景**：发现某个请求很慢，想看看它在各个节点的耗时分布

**操作步骤**：

1. **进入性能分析页面**
   - 导航：链路监控 → 性能分析

2. **查询数据**
   - 选择链路和时间范围
   - 点击查询

3. **在详细数据表格中找到该请求**
   - 可以通过请求ID搜索
   - 查看该请求在各节点的耗时

4. **或者通过API直接查询**：
   ```bash
   GET /v1/chain/collection/latency/req_12345
   ```
   返回该请求的完整链路耗时和各节点耗时

---

## 常见问题

### Q1: 为什么看不到节点数据？

**可能原因**：
1. 数据收集未启动
2. 时间范围选择不正确
3. 节点日志路径配置错误
4. 日志解析规则配置错误

**解决方法**：
1. 确认数据收集已启动（数据收集页面查看状态）
2. 确认时间范围包含数据收集的时间段
3. 检查节点配置中的日志路径是否正确
4. 检查日志解析规则是否能正确提取延时数据

### Q2: 为什么整体耗时不等于各节点耗时之和？

**原因**：
- 整体耗时 = 最后一个节点的结束时间 - 第一个节点的开始时间
- 各节点耗时之和 = 各节点自身处理时间之和
- 两者可能不相等，因为：
  - 节点之间可能有网络传输时间
  - 节点之间可能有等待时间
  - 节点处理可能是并行的

**正确理解**：
- **整体耗时**：用户感受到的总耗时（端到端）
- **节点耗时**：各节点自身的处理时间

### Q3: 如何识别性能瓶颈？

**方法**：
1. 查看 **瓶颈节点分析** 表格（性能分析页面）
2. 对比各节点的平均延时和P95延时
3. 查看错误率较高的节点
4. 系统会自动标记瓶颈节点并给出建议

**判断标准**：
- 平均延时明显高于其他节点
- P95延时超过阈值
- 错误率超过5%
- 延时波动较大

### Q4: 数据收集启动后多久能看到数据？

**时间**：
- 数据收集启动后，系统会立即开始读取日志文件
- 如果日志文件中有新数据，通常几秒内就能看到
- 如果日志文件更新较慢，可能需要等待日志写入

**建议**：
- 启动数据收集后，等待1-2分钟再查询数据
- 确认日志文件路径正确且文件正在被写入

### Q5: 如何导出分析报告？

**方法**：
1. 进入 **性能分析** 页面
2. 查询数据后，点击 **导出报告** 按钮
3. 系统会生成包含所有分析结果的报告文件

---

## 最佳实践

### 1. 压测前准备

- ✅ 提前配置好链路和节点
- ✅ 确认日志路径和解析规则正确
- ✅ 测试数据收集功能是否正常

### 2. 压测过程中

- ✅ 启动数据收集后再开始压测
- ✅ 使用实时监控页面观察性能变化
- ✅ 关注性能指标卡片的异常值

### 3. 压测后分析

- ✅ 使用性能分析页面进行深度分析
- ✅ 重点关注瓶颈节点分析结果
- ✅ 导出分析报告用于后续优化

### 4. 性能优化

- ✅ 根据瓶颈节点分析结果优化对应服务
- ✅ 对比优化前后的性能数据
- ✅ 持续监控关键链路的性能指标

---

## 技术说明

### 数据收集原理

1. **日志解析**：系统从各节点的日志文件中提取延时数据
2. **数据关联**：基于请求ID将同一请求在不同节点的数据关联
3. **耗时计算**：
   - 节点耗时 = 节点结束时间 - 节点开始时间
   - 链路总耗时 = 最后一个节点结束时间 - 第一个节点开始时间

### 数据存储

- **实时数据**：存储在 InfluxDB（用于快速查询和实时展示）
- **历史数据**：存储在 MySQL（用于详细分析和报表）
- **原始日志**：可配置是否保存原始日志数据

### 性能指标计算

- **平均值**：使用 SQL AVG 函数
- **P95/P99**：使用 SQL PERCENTILE_CONT 函数
- **成功率**：(成功请求数 / 总请求数) × 100%
- **错误率**：(失败请求数 / 总请求数) × 100%

---

**文档版本**: v1.0  
**最后更新**: 2024-11-19  
**维护者**: Easy JMeter Team

