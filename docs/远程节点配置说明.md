# 远程节点配置说明

## 概述

链路延时监控系统现在支持远程节点配置，可以监控部署在不同服务器上的节点。系统支持两种操作系统：

- **Linux节点**：通过SSH连接，使用AWK脚本解析日志
- **Windows节点**：通过SMB共享或本地文件系统，使用Java正则表达式解析日志

## 功能特性

### 1. 本地节点
- 直接读取本地文件系统上的日志文件
- 支持Linux和Windows本地路径
- Linux节点使用AWK脚本解析，Windows节点使用Java正则表达式解析

### 2. 远程Linux节点
- 通过SSH连接到远程服务器
- 支持密码认证和SSH密钥认证（优先使用密钥）
- 使用AWK脚本在远程服务器上解析日志
- 支持自定义SSH端口

### 3. 远程Windows节点
- 通过SMB共享路径访问日志文件
- 使用Java正则表达式解析日志（Windows系统不支持AWK）
- 支持本地路径和网络共享路径

## 配置说明

### 节点类型选择

在创建或编辑节点时，首先选择节点类型：

1. **本地节点（LOCAL）**
   - 日志文件在本地服务器上
   - 不需要配置远程连接信息

2. **远程Linux节点（SSH）**
   - 日志文件在远程Linux服务器上
   - 需要配置SSH连接信息

3. **远程Windows节点（RDP）**
   - 日志文件在远程Windows服务器上
   - 需要配置SMB共享路径或使用本地路径

### 远程连接配置

#### Linux节点（SSH）

**必填字段**：
- **主机地址**：远程服务器的IP地址或域名（如：192.168.1.100 或 server.example.com）
- **端口**：SSH端口，默认22
- **用户名**：SSH登录用户名
- **密码**：SSH登录密码（或配置SSH私钥）
- **操作系统类型**：选择"Linux"

**可选字段**：
- **SSH私钥路径**：本地SSH私钥文件路径（如果配置了私钥，将优先使用密钥认证）
- **连接超时**：SSH连接超时时间（秒），默认30秒
- **读取超时**：读取日志文件超时时间（秒），默认60秒

**日志路径示例**：
- `/var/log/app/app.log`
- `/home/user/logs/service.log`

#### Windows节点

**必填字段**：
- **主机地址**：远程服务器的IP地址或域名
- **端口**：RDP端口，默认3389（实际不使用，仅用于标识）
- **用户名**：Windows用户名
- **密码**：Windows密码
- **操作系统类型**：选择"Windows"

**日志路径支持两种方式**：

1. **本地路径**（如果日志文件在Windows服务器本地）：
   - `C:\logs\app.log`
   - `D:\application\logs\service.log`

2. **SMB共享路径**（推荐，如果日志文件在网络共享上）：
   - `\\192.168.1.100\logs\app.log`
   - `\\server\share\application.log`

**注意**：Windows节点使用Java正则表达式解析日志，不支持AWK脚本。

### 日志解析规则

#### Linux节点（AWK解析）

日志解析使用AWK脚本，支持以下正则表达式模式：

- **日志匹配模式**：用于过滤日志行
- **时间戳提取模式**：提取时间戳（第一个捕获组）
- **请求ID提取模式**：提取请求ID（第一个捕获组）
- **延时提取模式**：提取延时值（第一个捕获组）

**示例配置**：
```
日志匹配模式: Request received
时间戳模式: (\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})
请求ID模式: requestId=([^,]+)
延时模式: latency=(\d+)ms
```

#### Windows节点（Java正则解析）

Windows节点使用Java正则表达式解析，配置方式与Linux相同，但解析在本地Java代码中执行。

**示例日志格式**：
```
2024-11-19 10:00:00.123 [INFO] Request received: requestId=req_001, path=/api/order, latency=45ms
```

**解析规则**：
- 时间戳：`(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})`
- 请求ID：`requestId=([^,]+)`
- 延时：`latency=(\d+)ms`

## 安全建议

### 1. SSH密钥认证（推荐）

对于Linux节点，建议使用SSH密钥认证而不是密码：

1. 生成SSH密钥对：
   ```bash
   ssh-keygen -t rsa -b 4096 -f ~/.ssh/chain_monitor_key
   ```

2. 将公钥复制到远程服务器：
   ```bash
   ssh-copy-id -i ~/.ssh/chain_monitor_key.pub user@remote-server
   ```

3. 在节点配置中填写私钥路径：
   ```
   /home/user/.ssh/chain_monitor_key
   ```

### 2. 密码加密存储

系统会将密码加密存储在数据库中，但仍建议：
- 使用强密码
- 定期更换密码
- 限制SSH访问IP（通过防火墙）

### 3. SMB共享安全

对于Windows节点使用SMB共享：
- 使用专用账户，不要使用管理员账户
- 限制共享文件夹的访问权限
- 使用SMB 3.0及以上版本（支持加密）

## 常见问题

### Q1: SSH连接失败怎么办？

**检查清单**：
1. ✅ 主机地址和端口是否正确？
2. ✅ 用户名和密码是否正确？
3. ✅ 远程服务器SSH服务是否启动？
4. ✅ 防火墙是否允许SSH连接？
5. ✅ SSH密钥路径是否正确（如果使用密钥）？

**解决方法**：
- 使用SSH客户端测试连接：`ssh -p 22 user@host`
- 检查SSH服务状态：`systemctl status sshd`（Linux）
- 查看系统日志获取详细错误信息

### Q2: Windows节点无法读取日志文件？

**可能原因**：
1. SMB共享路径格式错误
2. 用户名密码不正确
3. 共享文件夹权限不足
4. 网络连接问题

**解决方法**：
- 使用Windows资源管理器测试访问：`\\192.168.1.100\share`
- 检查共享文件夹权限
- 使用本地路径（如果可能）

### Q3: 日志解析失败？

**检查清单**：
1. ✅ 日志文件路径是否正确？
2. ✅ 日志格式是否匹配配置的正则表达式？
3. ✅ 正则表达式是否正确（特别是捕获组）？

**解决方法**：
- 使用在线正则表达式测试工具验证正则表达式
- 查看系统日志获取详细错误信息
- 确认日志文件格式与配置一致

### Q4: Windows节点为什么不用AWK？

Windows系统默认不包含AWK工具，需要额外安装。为了简化部署和维护，Windows节点使用Java正则表达式在本地解析日志，这样可以：
- 无需在Windows服务器上安装额外工具
- 统一使用Java代码，便于维护
- 性能足够满足需求

## 测试建议

### 1. 测试SSH连接

在配置节点前，先测试SSH连接：

```bash
# 测试密码认证
ssh -p 22 user@192.168.1.100

# 测试密钥认证
ssh -i /path/to/private/key -p 22 user@192.168.1.100
```

### 2. 测试日志文件访问

```bash
# Linux节点
ssh user@192.168.1.100 "cat /var/log/app/app.log | head -10"

# Windows节点（SMB）
# 在Windows资源管理器中访问：\\192.168.1.100\share
```

### 3. 测试日志解析

配置节点后，启动数据收集，查看是否能正确解析日志：
- 检查数据收集状态
- 查看收集到的数据
- 验证各字段是否正确提取

## 性能考虑

### 1. 网络延迟

远程节点收集数据会受到网络延迟影响：
- SSH连接建立需要时间
- 日志文件传输需要时间
- 建议设置合理的超时时间

### 2. 并发连接

系统支持多个远程节点并发收集：
- 每个节点独立连接
- 建议控制节点数量，避免过多并发连接

### 3. 日志文件大小

对于大型日志文件：
- 考虑使用日志轮转
- 只收集最近的日志数据
- 使用增量收集方式

## 总结

远程节点功能使得系统可以监控分布式环境中的各个节点，支持Linux和Windows两种操作系统。正确配置后，可以无缝收集和分析各节点的延时数据，实现完整的链路监控。

