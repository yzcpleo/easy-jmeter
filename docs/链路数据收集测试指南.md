# 链路数据收集功能测试指南

## 测试准备

### 1. 准备测试日志文件

测试日志文件已创建在 `api/test-logs/` 目录下：

- `gateway.log` - 网关节点日志（20条记录）
- `order-service.log` - 订单服务节点日志（13条记录）
- `payment-service.log` - 支付服务节点日志（8条记录）
- `database.log` - 数据库节点日志（20条记录）

**日志格式说明**：
- 时间戳格式：`yyyy-MM-dd HH:mm:ss.SSS`
- 请求ID格式：`requestId=req_XXX`
- 延时格式：`latency=XXXms`

### 2. 配置链路和节点

#### 步骤1：创建链路

1. 登录系统
2. 进入 **链路延时监控** → **链路管理**
3. 点击 **新增链路**
4. 填写信息：
   - 链路名称：`测试链路`
   - 链路描述：`用于测试数据收集功能`
5. 保存

#### 步骤2：配置节点

为每个节点配置日志路径和解析规则：

**节点1：网关（Gateway）**
- 节点名称：`网关`
- 日志路径：`F:\BaiduNetdiskDownload\easy-jmeter1\easy-jmeter\api\test-logs\gateway.log`
- 日志匹配模式：`Request received`
- 时间戳模式：`(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})`
- 请求ID模式：`requestId=([^,]+)`
- 延时模式：`latency=(\d+)ms`
- 执行顺序：`1`

**节点2：订单服务（OrderService）**
- 节点名称：`订单服务`
- 日志路径：`F:\BaiduNetdiskDownload\easy-jmeter1\easy-jmeter\api\test-logs\order-service.log`
- 日志匹配模式：`Processing order request`
- 时间戳模式：`(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})`
- 请求ID模式：`requestId=([^,]+)`
- 延时模式：`latency=(\d+)ms`
- 执行顺序：`2`

**节点3：支付服务（PaymentService）**
- 节点名称：`支付服务`
- 日志路径：`F:\BaiduNetdiskDownload\easy-jmeter1\easy-jmeter\api\test-logs\payment-service.log`
- 日志匹配模式：`Processing payment request`
- 时间戳模式：`(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})`
- 请求ID模式：`requestId=([^,]+)`
- 延时模式：`latency=(\d+)ms`
- 执行顺序：`3`

**节点4：数据库（Database）**
- 节点名称：`数据库`
- 日志路径：`F:\BaiduNetdiskDownload\easy-jmeter1\easy-jmeter\api\test-logs\database.log`
- 日志匹配模式：`Database query executed`
- 时间戳模式：`(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})`
- 请求ID模式：`requestId=([^,]+)`
- 延时模式：`latency=(\d+)ms`
- 执行顺序：`4`

---

## 测试步骤

### 测试1：启动数据收集

1. 进入 **链路延时监控** → **数据收集**
2. 选择链路：`测试链路`
3. 输入任务ID：`1`（或任意数字）
4. 点击 **启动收集** 按钮
5. **预期结果**：
   - 显示"数据收集已启动"
   - 收集状态显示为"COLLECTING"
   - 开始时间显示当前时间

### 测试2：查看实时数据

1. 在 **数据收集** 页面，等待5-10秒
2. 点击 **刷新** 按钮
3. **预期结果**：
   - 收集状态显示总记录数、成功记录数、错误记录数
   - 实时数据表格显示收集到的延时数据
   - 图表显示各节点的延时趋势

### 测试3：查看各节点耗时统计

1. 进入 **链路延时监控** → **性能分析**
2. 选择链路：`测试链路`
3. 选择时间范围：`2024-11-19 10:00:00` 至 `2024-11-19 10:20:00`
4. 选择时间粒度：`分钟`
5. 点击 **查询** 按钮
6. **预期结果**：
   - **性能概览**显示：
     - 平均延时：约120-150ms（整体链路）
     - P95延时：约250-300ms
     - 成功率：100%
     - 总请求数：20（网关节点有20条记录）
   - **节点性能对比表格**显示：
     - 网关：平均约50ms
     - 订单服务：平均约130ms
     - 支付服务：平均约90ms
     - 数据库：平均约26ms
   - **瓶颈节点分析**：可能显示"订单服务"为瓶颈节点

### 测试4：查看整体耗时统计

1. 在 **性能分析** 页面，查看 **性能概览** 卡片
2. **预期结果**：
   - **平均链路延时**：约120-150ms（从网关到数据库的总耗时）
   - **P95链路延时**：约250-300ms
   - **最大链路延时**：约300-350ms

### 测试5：查看单个请求的完整链路

1. 在 **性能分析** 页面，滚动到 **详细数据** 表格
2. 找到 `req_001` 请求
3. **预期结果**：
   - 该请求在多个节点都有数据
   - 可以看到该请求在各节点的耗时：
     - 网关：45ms
     - 订单服务：120ms
     - 数据库：25ms
   - 整体耗时：约190ms（45+120+25，加上网络传输时间）

### 测试6：停止数据收集

1. 返回 **数据收集** 页面
2. 点击 **停止收集** 按钮
3. **预期结果**：
   - 显示"数据收集已停止"
   - 收集状态显示为"STOPPED"
   - 结束时间显示当前时间

---

## 测试数据说明

### 测试日志数据统计

| 节点 | 记录数 | 平均延时 | 说明 |
|------|--------|----------|------|
| 网关 | 20条 | ~50ms | 所有请求都经过网关 |
| 订单服务 | 13条 | ~130ms | 只有订单相关请求 |
| 支付服务 | 8条 | ~90ms | 只有支付相关请求 |
| 数据库 | 20条 | ~26ms | 所有请求都访问数据库 |

### 请求ID分布

- `req_001` - `req_020`：共20个请求
- 订单相关请求：`req_001, req_002, req_004, req_006, req_007, req_009, req_011, req_012, req_014, req_016, req_017, req_019`（12个）
- 支付相关请求：`req_003, req_005, req_008, req_010, req_013, req_015, req_018, req_020`（8个）

### 预期统计结果

**整体链路性能**：
- 平均延时：约120-150ms
- P95延时：约250-300ms
- 成功率：100%（所有请求都成功）

**各节点性能**：
- 网关：平均50ms，P95 67ms
- 订单服务：平均130ms，P95 145ms（瓶颈节点）
- 支付服务：平均90ms，P95 98ms
- 数据库：平均26ms，P95 31ms

---

## 自动化测试脚本

可以使用 `api/test-chain-collection.bat` 脚本进行自动化测试：

```bash
cd api
test-chain-collection.bat
```

**注意**：脚本中的 `YOUR_TOKEN` 需要替换为实际的认证token。

---

## 常见问题

### Q1: 数据收集启动后没有数据？

**检查清单**：
1. ✅ 日志文件路径是否正确？
2. ✅ 日志文件是否存在且可读？
3. ✅ 日志解析规则是否正确？
4. ✅ 日志格式是否匹配？

**解决方法**：
- 检查日志文件路径（使用绝对路径）
- 确认日志文件中有符合格式的数据
- 检查正则表达式是否正确

### Q2: 节点性能对比显示数据不一致？

**可能原因**：
- 不同节点的日志记录数不同（订单服务只有13条，支付服务只有8条）
- 这是正常的，因为不是所有请求都经过所有节点

**解决方法**：
- 查看详细数据表格，确认数据是否正确关联
- 检查请求ID是否一致

### Q3: 整体耗时不等于各节点耗时之和？

**原因**：
- 整体耗时 = 最后一个节点结束时间 - 第一个节点开始时间
- 各节点耗时之和 = 各节点自身处理时间之和
- 两者可能不相等，因为包含网络传输、等待时间等

**这是正常的**，整体耗时更能反映用户体验。

---

## 测试检查清单

- [ ] 数据收集可以正常启动
- [ ] 数据收集可以正常停止
- [ ] 可以查询到收集的数据
- [ ] 各节点耗时统计正确
- [ ] 整体耗时统计正确
- [ ] 节点性能对比图表正常显示
- [ ] 瓶颈节点分析正确
- [ ] 详细数据表格显示完整
- [ ] 实时监控功能正常
- [ ] 性能分析功能正常

---

**测试完成后，请填写测试结果并记录发现的问题。**

