# 数据库迁移说明

## 问题描述

如果遇到 `{"code":9999,"message":"服务器未知错误"}` 错误，通常是因为数据库表结构没有更新，缺少新增的字段。

## 解决方案

### 步骤1：执行数据库表结构更新

执行以下SQL脚本，添加新字段：

```sql
-- 执行 init_db/add_remote_node_fields.sql
```

或者手动执行：

```sql
ALTER TABLE chain_node_config 
ADD COLUMN IF NOT EXISTS node_host VARCHAR(255) COMMENT '节点主机地址（IP或域名），为空表示本地节点',
ADD COLUMN IF NOT EXISTS node_port INT DEFAULT 22 COMMENT 'SSH端口（Linux）或RDP端口（Windows），默认22',
ADD COLUMN IF NOT EXISTS node_username VARCHAR(100) COMMENT '远程连接用户名',
ADD COLUMN IF NOT EXISTS node_password VARCHAR(255) COMMENT '远程连接密码（加密存储）',
ADD COLUMN IF NOT EXISTS os_type VARCHAR(20) DEFAULT 'LINUX' COMMENT '操作系统类型：LINUX- Linux系统，WINDOWS- Windows系统',
ADD COLUMN IF NOT EXISTS connection_type VARCHAR(20) DEFAULT 'LOCAL' COMMENT '连接类型：LOCAL-本地，SSH- SSH连接，RDP- RDP连接（Windows）',
ADD COLUMN IF NOT EXISTS ssh_key_path VARCHAR(500) COMMENT 'SSH私钥路径（可选，优先使用密钥认证）',
ADD COLUMN IF NOT EXISTS connection_timeout INT DEFAULT 30 COMMENT '连接超时时间（秒）',
ADD COLUMN IF NOT EXISTS read_timeout INT DEFAULT 60 COMMENT '读取超时时间（秒）',
ADD COLUMN IF NOT EXISTS custom_shell_script TEXT COMMENT '自定义Shell脚本（用于解析非标准格式日志，输出格式：requestId|timestamp|latency|originalLine）',
ADD COLUMN IF NOT EXISTS use_custom_script TINYINT DEFAULT 0 COMMENT '是否使用自定义脚本：1-是，0-否（使用AWK或正则）',
ADD COLUMN IF NOT EXISTS parse_method VARCHAR(20) DEFAULT 'JAVA_REGEX' COMMENT '解析方式：AUTO-自动（Linux用AWK，Windows用Java正则），AWK-AWK脚本，JAVA_REGEX-Java正则表达式';

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_node_host ON chain_node_config(node_host);
CREATE INDEX IF NOT EXISTS idx_os_type ON chain_node_config(os_type);
```

### 步骤2：更新现有数据（可选）

如果表中已有数据，执行以下脚本更新默认值：

```sql
-- 执行 init_db/update_existing_nodes.sql
```

或者手动执行：

```sql
UPDATE chain_node_config 
SET 
    os_type = COALESCE(os_type, 'LINUX'),
    connection_type = COALESCE(connection_type, 'LOCAL'),
    parse_method = COALESCE(parse_method, 'JAVA_REGEX'),
    node_port = COALESCE(node_port, 22),
    connection_timeout = COALESCE(connection_timeout, 30),
    read_timeout = COALESCE(read_timeout, 60),
    use_custom_script = COALESCE(use_custom_script, 0)
WHERE 
    os_type IS NULL 
    OR connection_type IS NULL 
    OR parse_method IS NULL
    OR (node_port IS NULL AND node_host IS NOT NULL)
    OR connection_timeout IS NULL
    OR read_timeout IS NULL
    OR use_custom_script IS NULL;
```

## 代码兼容性处理

代码中已经添加了兼容性处理：

1. **`ChainNodeConfigServiceImpl.getNodeById()`**：在返回节点数据前，会自动设置默认值
2. **`ChainNodeConfigServiceImpl.getNodesByChainId()`**：在返回节点列表前，会自动为每个节点设置默认值

即使数据库表中字段为NULL，代码也会自动填充默认值，确保前端能正常显示。

## 验证

执行以下SQL验证字段是否已添加：

```sql
DESCRIBE chain_node_config;
```

应该能看到以下新字段：
- `node_host`
- `node_port`
- `node_username`
- `node_password`
- `os_type`
- `connection_type`
- `ssh_key_path`
- `connection_timeout`
- `read_timeout`
- `custom_shell_script`
- `use_custom_script`
- `parse_method`

## 注意事项

1. **备份数据**：在执行ALTER TABLE之前，建议先备份数据库
2. **生产环境**：在生产环境执行前，请在测试环境先验证
3. **字段默认值**：新字段都有默认值，不会影响现有数据

