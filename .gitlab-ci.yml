# Easy JMeter GitLab CI/CD Pipeline
# Dockeræµæ°´çº¿éƒ¨ç½²ç¤ºä¾‹

stages:
  - build
  - package
  - deploy
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_REGISTRY: "$CI_REGISTRY"
  PROJECT_NAME: "easy-jmeter"
  MAVEN_IMAGE: "maven:3.8.4-openjdk-8"
  DOCKER_IMAGE: "docker:20.10.16"

# ç¼“å­˜Mavenä¾èµ–
cache:
  paths:
    - .m2/repository/

# Mavenæ„å»ºJARåŒ…
build:jar:
  stage: build
  image: $MAVEN_IMAGE
  script:
    - echo "ğŸ”¨ Building Easy JMeter JAR package..."
    - cd api
    - mvn clean package -DskipTests -Dcheckstyle.skip
    - echo "âœ… JAR build completed"
    - ls -la target/
  artifacts:
    paths:
      - api/target/*.jar
    expire_in: 2 hours
    reports:
      junit:
        - api/target/surefire-reports/TEST-*.xml
  only:
    - main
    - develop
    - merge_requests

# Dockeré•œåƒæ„å»º
build:docker:
  stage: package
  image: $DOCKER_IMAGE
  services:
    - docker:20.10.16-dind
  before_script:
    - echo "ğŸ³ Setting up Docker environment..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ—ï¸ Building Docker images..."
    - export VERSION=${CI_COMMIT_SHORT_SHA}
    
    # æ„å»ºServeré•œåƒ
    - docker build -f docker/Dockerfile.server 
        -t $CI_REGISTRY_IMAGE/server:$VERSION 
        -t $CI_REGISTRY_IMAGE/server:latest 
        --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" 
        --build-arg VERSION=$VERSION .
    
    # æ„å»ºAgenté•œåƒ  
    - docker build -f docker/Dockerfile.agent 
        -t $CI_REGISTRY_IMAGE/agent:$VERSION 
        -t $CI_REGISTRY_IMAGE/agent:latest 
        --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" 
        --build-arg VERSION=$VERSION .
    
    # æ¨é€é•œåƒ
    - echo "ğŸ“¤ Pushing images to registry..."
    - docker push $CI_REGISTRY_IMAGE/server:$VERSION
    - docker push $CI_REGISTRY_IMAGE/agent:$VERSION
    
    # æ¨é€latestæ ‡ç­¾ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker push $CI_REGISTRY_IMAGE/server:latest
        docker push $CI_REGISTRY_IMAGE/agent:latest
      fi
    
    - echo "âœ… Docker images built and pushed successfully"
    
    # æ˜¾ç¤ºé•œåƒä¿¡æ¯
    - docker images | grep $CI_REGISTRY_IMAGE
  dependencies:
    - build:jar
  only:
    - main
    - develop

# å¼€å‘ç¯å¢ƒéƒ¨ç½²
deploy:dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ Deploying to development environment..."
    - export VERSION=${CI_COMMIT_SHORT_SHA}
    
    # å¤åˆ¶éƒ¨ç½²æ–‡ä»¶
    - scp -r docker/ deploy/ $DEV_USER@$DEV_HOST:~/easy-jmeter/
    
    # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²
    - ssh $DEV_USER@$DEV_HOST "
        cd ~/easy-jmeter && 
        export VERSION=$VERSION &&
        export REGISTRY=$CI_REGISTRY &&
        echo 'Pulling latest images...' &&
        docker pull $CI_REGISTRY_IMAGE/server:$VERSION &&
        docker pull $CI_REGISTRY_IMAGE/agent:$VERSION &&
        echo 'Deploying services...' &&
        ./deploy/deploy.sh $VERSION &&
        echo 'âœ… Development deployment completed'
      "
    
    # å¥åº·æ£€æŸ¥
    - sleep 30
    - curl -f http://$DEV_HOST:5000/actuator/health || exit 1
    - echo "âœ… Development environment is healthy"
  environment:
    name: development
    url: http://$DEV_HOST
  dependencies:
    - build:docker
  only:
    - develop
  when: manual

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
deploy:prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H $PROD_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸ¯ Deploying to production environment..."
    - export VERSION=${CI_COMMIT_SHORT_SHA}
    
    # å¤åˆ¶éƒ¨ç½²æ–‡ä»¶
    - scp -r docker/ deploy/ $PROD_USER@$PROD_HOST:~/easy-jmeter/
    
    # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    - ssh $PROD_USER@$PROD_HOST "
        cd ~/easy-jmeter && 
        export VERSION=$VERSION &&
        export REGISTRY=$CI_REGISTRY &&
        echo 'Creating backup...' &&
        docker-compose -f docker/docker-compose.prod.yml ps > deployment-backup.log &&
        echo 'Pulling production images...' &&
        docker pull $CI_REGISTRY_IMAGE/server:$VERSION &&
        docker pull $CI_REGISTRY_IMAGE/agent:$VERSION &&
        echo 'Deploying to production...' &&
        ./deploy/deploy.sh $VERSION .env.prod &&
        echo 'âœ… Production deployment completed'
      "
    
    # ç”Ÿäº§ç¯å¢ƒéªŒè¯
    - sleep 60
    - curl -f http://$PROD_HOST:5000/actuator/health || exit 1
    - echo "âœ… Production environment is healthy"
    
    # å‘é€é€šçŸ¥
    - |
      curl -X POST "$SLACK_WEBHOOK_URL" \
        -H 'Content-type: application/json' \
        --data "{\"text\":\"ğŸš€ Easy JMeter v$VERSION deployed to production successfully!\"}"
  environment:
    name: production
    url: http://$PROD_HOST
  dependencies:
    - build:docker
  only:
    - main
  when: manual

# é›†æˆæµ‹è¯•
test:integration:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "ğŸ§ª Running integration tests..."
    
    # APIå¥åº·æ£€æŸ¥
    - |
      for i in {1..10}; do
        if curl -s http://$DEV_HOST:5000/actuator/health | jq -r '.status' | grep -q UP; then
          echo "âœ… Server API is healthy"
          break
        fi
        echo "Waiting for server... ($i/10)"
        sleep 10
      done
    
    # Socket.IOè¿é€šæ€§æµ‹è¯•
    - curl -s http://$DEV_HOST:9000/socket.io/ | grep -q "Socket.IO" && echo "âœ… Socket.IO is accessible"
    
    # MinIOè¿é€šæ€§æµ‹è¯•
    - curl -s http://$DEV_HOST:9000/minio/health/live | grep -q "OK" && echo "âœ… MinIO is healthy"
    
    - echo "âœ… Integration tests passed"
  dependencies:
    - deploy:dev
  only:
    - develop
  allow_failure: true

# æ¸…ç†èµ„æº
cleanup:
  stage: .post
  image: $DOCKER_IMAGE
  services:
    - docker:20.10.16-dind
  script:
    - echo "ğŸ§¹ Cleaning up Docker resources..."
    - docker system prune -f --volumes
    - docker builder prune -f
    - echo "âœ… Cleanup completed"
  when: always
  only:
    - main
    - develop
